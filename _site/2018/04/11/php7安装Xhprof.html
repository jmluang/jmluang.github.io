<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cmn-Hans" lang="zh-cmn-Hans">
<head>

    <link rel="shortcut icon" href="/images/favicon.icon" type="image/x-icon">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>php7安装Xhprof</title>
    <meta name="author" content="liang Juming" />

    <!-- Homepage CSS -->
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

    <link rel="stylesheet" href="/css/atom-one-dark.css">
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

  <div class="site">
      <div class="title">
    <a href="/">Jm's Blog</a>
    <a class="extra" href="/about">about</a>
  </div>

<div id="post">
  <p class="title">php7安装Xhprof</p>
  <span class="time">2018年04月11日</span>
  <p>由于官方的 Xhprof 目前已经不再维护了，所以不再支持 PHP7了
在 github 上找了一个<a href="https://github.com/longxinH/xhprof">项目</a> ，这个项目可以支持的版本还可以，而且说明也挺详细的，但是如果没看过源码的话就不建议在生产环境里用</p>

<p>首先按照步骤下载和安装项目</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. git clone https://github.com/longxinH/xhprof.git ./xhprof
2. cd xhprof/extension/
3. /path/to/php7/bin/phpize
4. ./configure --with-php-config=/path/to/php7/bin/php-config
5. make &amp;&amp; sudo make install
</code></pre></div></div>

<p>在 php.ini 文件加入配置</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[xhprof]
extension = xhprof.so
// 这里文件输出的目录，记得检查权限的问题
xhprof.output_dir = /tmp/xhprof
</code></pre></div></div>

<p>最后检查是否安装完成
` php -m | grep xhprof `</p>

<hr />

<p>然后就是在项目里定义在哪里启动和关闭 xhprof，由于我是只有一个项目，所以我利用 php-fpm 配置文件中的 <code class="highlighter-rouge">auto_prepend_file</code> 的配置，在每次运行的时候都注入到函数里面，开始就启动 xhprof，利用 php 自带的 <code class="highlighter-rouge">register_shutdown_function</code> 关闭 xhprof 并把数据记录到文件中，最后通过 web server来查看这些文件</p>

<ol>
  <li>在 php-fpm 能访问到的地方创建一个 injection 目录</li>
  <li>在 injection 目录中创建一个 inject.php 文件
```php
// inject.php
&lt;?php 
// xhprof start
xhprof_enable();</li>
</ol>

<p>register_shutdown_function(function() {
    // xhprof stop
	$xhprof_data = xhprof_disable();
	$XHPROF_ROOT = “/injection/”;
	include_once $XHPROF_ROOT . “xhprof_lib.php”;
	include_once $XHPROF_ROOT . “xhprof_runs.php”;
	// save raw data for this profiler run using default
	// // implementation of iXHProfRuns.
	$xhprof_runs = new XHProfRuns_Default();
	//
	// // save the run under a namespace “xhprof_foo”
	$xhprof_runs-&gt;save_run($xhprof_data,”inject”);
});</p>

<p>```</p>

<ol>
  <li>
    <p>复制 xhprof 项目中的文件到上面提到的 injection 目录
复制
 <code class="highlighter-rouge">/path/to/xhprof/xhprof_lib/utils/xhprof_lib.php</code> 
 和
 <code class="highlighter-rouge">/path/to/xhprof/xhprof_lib/utils/xhprof_runs.php</code></p>
  </li>
  <li>
    <p>配置 <code class="highlighter-rouge">php.ini</code>
` auto_prepend_file = /injection/inject.php `</p>
  </li>
</ol>

<p>基本就完成了，最后在 <code class="highlighter-rouge">/path/to/xhprof/xhprof_html/</code> 使用临时服务器 ` php -S 127.0.0.1:8000` ，浏览器打开就能看到了</p>

<blockquote>
  <p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p>
</blockquote>

</div>

<div id="splict">
</div>

<div id="related">
  <h4>相关文章</h4>
  <ul class="posts">
    
      <li>&raquo; <a href="/2018/03/24/Centos7%E9%85%8D%E7%BD%AE%E5%85%8D%E8%B4%B9https%E8%AF%81%E4%B9%A6.html">Centos7配置免费https证书</a></li>
    
      <li>&raquo; <a href="/2018/03/13/%E9%83%A8%E7%BD%B2-git-%E6%9C%8D%E5%8A%A1%E5%99%A8.html">部署 git 服务器</a></li>
    
      <li>&raquo; <a href="/2018/02/11/%E8%AE%B0%E5%BD%95%E4%B8%8B%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html">记录开发微信小程序中遇到的坑</a></li>
    
  </ul>
</div>
  <div class="footer">
    <div class="contact-left">
      <p>
        Luang Juming
        <br />
        ljm9601@hotmail.com
      </p>
    </div>
    <div class="contact-right">
      <p>
        <br />
        <a href="https://github.com/jmluang/jmluang.github.io">Theme by @jmluang</a>
      </p>
    </div>
  </div>


  </div>

<!-- <a href="http://github.com/jmluang"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a> -->

</body>
</html>
